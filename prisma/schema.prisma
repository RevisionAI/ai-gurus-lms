generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String
  surname     String
  password    String
  cellNumber  String
  company     String
  position    String
  workAddress String
  role        UserRole  @default(STUDENT)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  enrollments     Enrollment[]
  instructorCourses Course[] @relation("InstructorCourses")
  assignments     Assignment[]
  submissions     Submission[]
  discussions     Discussion[]
  discussionPosts DiscussionPost[]
  announcements   Announcement[]
  gradesReceived  Grade[] @relation("StudentGrades")
  gradesGiven     Grade[] @relation("GraderGrades")
  feedbackTemplates FeedbackTemplate[]

  @@index([deletedAt])
  @@map("users")
}

model Course {
  id                 String    @id @default(cuid())
  title              String
  description        String?
  code               String    @unique
  semester           String
  year               Int
  isActive           Boolean   @default(true)
  prerequisites      String?   // Free-text description of course prerequisites
  learningObjectives String[]  // Array of learning objective strings
  targetAudience     String?   // Description of intended audience
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  instructorId String
  instructor   User   @relation("InstructorCourses", fields: [instructorId], references: [id])
  enrollments  Enrollment[]
  assignments  Assignment[]
  discussions  Discussion[]
  announcements Announcement[]
  content      CourseContent[]

  @@index([deletedAt])
  @@map("courses")
}

model Enrollment {
  id         String   @id @default(cuid())
  enrolledAt DateTime @default(now())
  
  // Relations
  userId   String
  courseId String
  user     User   @relation(fields: [userId], references: [id])
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

model Assignment {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  maxPoints   Int       @default(100)
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  courseId    String
  createdById String
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdBy   User         @relation(fields: [createdById], references: [id])
  submissions Submission[]
  grades      Grade[]

  @@index([deletedAt])
  @@map("assignments")
}

model Submission {
  id          String   @id @default(cuid())
  content     String?
  fileUrl     String?
  s3Key       String?  // S3/R2 object key for file storage
  submittedAt DateTime @default(now())

  // Relations
  assignmentId String
  studentId    String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      User       @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@map("submissions")
}

model Grade {
  id        String    @id @default(cuid())
  points    Float
  feedback  String?
  gradedAt  DateTime  @default(now())
  deletedAt DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  assignmentId String
  studentId    String
  gradedById   String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      User       @relation("StudentGrades", fields: [studentId], references: [id])
  gradedBy     User       @relation("GraderGrades", fields: [gradedById], references: [id])

  @@unique([assignmentId, studentId])
  @@index([deletedAt])
  @@map("grades")
}

model Discussion {
  id          String    @id @default(cuid())
  title       String
  description String?
  isPinned    Boolean   @default(false)
  isLocked    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  courseId  String
  createdBy String
  course    Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author    User             @relation(fields: [createdBy], references: [id])
  posts     DiscussionPost[]

  @@index([deletedAt])
  @@map("discussions")
}

model DiscussionPost {
  id        String   @id @default(cuid())
  content   String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  discussionId String
  authorId     String
  discussion   Discussion       @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  author       User             @relation(fields: [authorId], references: [id])
  parent       DiscussionPost?  @relation("PostReplies", fields: [parentId], references: [id])
  replies      DiscussionPost[] @relation("PostReplies")
  
  @@map("discussion_posts")
}

model Announcement {
  id        String    @id @default(cuid())
  title     String
  content   String
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  courseId String
  authorId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  author   User   @relation(fields: [authorId], references: [id])

  @@index([deletedAt])
  @@map("announcements")
}

model CourseContent {
  id             String      @id @default(cuid())
  title          String
  type           ContentType
  content        String?
  fileUrl        String?
  s3Key          String?     // S3/R2 object key for file storage
  thumbnailUrl   String?
  thumbnailS3Key String?     // S3/R2 object key for thumbnail
  orderIndex     Int
  isPublished    Boolean     @default(false)
  createdAt      DateTime    @default(now())
  deletedAt      DateTime?   // Soft delete timestamp (NULL = active, timestamp = deleted)

  // Relations
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("course_content")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum ContentType {
  TEXT
  VIDEO
  DOCUMENT
  LINK
  SCORM
  YOUTUBE
}

model FeedbackTemplate {
  id           String   @id @default(cuid())
  name         String
  category     String   // excellent, needs-improvement, missing-requirements, late
  template     String   @db.Text
  instructorId String
  instructor   User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  isShared     Boolean  @default(false)
  usageCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([instructorId])
  @@index([category])
  @@map("feedback_templates")
}