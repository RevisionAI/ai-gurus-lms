<story-context id="bmad/bmm/workflows/4-implementation/story-context/2-4-module-content-management" v="1.0">
  <metadata>
    <epicId>epic-2</epicId>
    <storyId>2-4-module-content-management</storyId>
    <title>Module Content Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-28</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-4-module-content-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>an instructor</asA>
    <iWant>to view and manage content within a module</iWant>
    <soThat>I can organize learning materials</soThat>
    <tasks>
      <task id="1" status="pending">
        <title>Create expandable module card (AC: 1)</title>
        <subtasks>
          <subtask id="1.1">Add expand/collapse toggle to ModuleCard</subtask>
          <subtask id="1.2">Track expansion state per card</subtask>
          <subtask id="1.3">Animate expand/collapse transition</subtask>
          <subtask id="1.4">Load content items on expand (or eager load with modules)</subtask>
        </subtasks>
      </task>
      <task id="2" status="pending">
        <title>Create ModuleContentList component (AC: 2)</title>
        <subtasks>
          <subtask id="2.1">Create src/components/modules/ModuleContentList.tsx</subtask>
          <subtask id="2.2">Display content items in order (by orderIndex)</subtask>
          <subtask id="2.3">Show type icon (TEXT=üìÑ, VIDEO=üé¨, DOCUMENT=üìÅ, LINK=üîó, SCORM=üì¶, YOUTUBE=‚ñ∂Ô∏è)</subtask>
          <subtask id="2.4">Show publish status indicator (dot or badge)</subtask>
          <subtask id="2.5">Make items clickable to navigate to content editor</subtask>
        </subtasks>
      </task>
      <task id="3" status="pending">
        <title>Implement content reordering within module (AC: 3)</title>
        <subtasks>
          <subtask id="3.1">Apply @dnd-kit sortable to content list</subtask>
          <subtask id="3.2">Add drag handles to content items</subtask>
          <subtask id="3.3">Create API endpoint: PUT /api/instructor/courses/[id]/modules/[moduleId]/content/reorder</subtask>
          <subtask id="3.4">Update orderIndex on drag-end</subtask>
        </subtasks>
      </task>
      <task id="4" status="pending">
        <title>Add "Add Content" button (AC: 4)</title>
        <subtasks>
          <subtask id="4.1">Add "Add Content" button in expanded module area</subtask>
          <subtask id="4.2">Button opens content creation flow</subtask>
          <subtask id="4.3">Pass moduleId to content creation</subtask>
        </subtasks>
      </task>
      <task id="5" status="pending">
        <title>Update content creation form (AC: 5)</title>
        <subtasks>
          <subtask id="5.1">Find existing content creation form</subtask>
          <subtask id="5.2">Add moduleId parameter acceptance</subtask>
          <subtask id="5.3">Pre-select module in form if moduleId provided</subtask>
          <subtask id="5.4">Ensure moduleId is sent with content creation API</subtask>
        </subtasks>
      </task>
      <task id="6" status="pending">
        <title>Integration with existing content UI (AC: 6)</title>
        <subtasks>
          <subtask id="6.1">Verify existing content edit works from module context</subtask>
          <subtask id="6.2">Content detail/edit page should show module context</subtask>
          <subtask id="6.3">Ensure navigation back returns to correct module</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Expandable module card shows content items</criterion>
    <criterion id="2">Content items show title, type icon, publish status</criterion>
    <criterion id="3">Drag-and-drop reordering within module</criterion>
    <criterion id="4">"Add Content" button within module context</criterion>
    <criterion id="5">Content creation form pre-selects current module</criterion>
    <criterion id="6">Existing content management UI works within module</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/PRD-course-modules.md" section="Functional Requirements">
        <relevance>FR006-FR009 define content organization requirements within modules</relevance>
        <keyPoints>
          - FR006: Course content items belong to exactly one module
          - FR007: Instructors can move content items between modules
          - FR008: Content items maintain order index within their module
          - FR009: Drag-and-drop reordering works within module context
        </keyPoints>
      </doc>
      <doc path="docs/architecture-course-modules.md" section="Project Structure">
        <relevance>Defines component structure and API patterns for module content management</relevance>
        <keyPoints>
          - Component location: src/components/modules/ModuleContentList.tsx
          - API endpoint pattern: /api/instructor/courses/[id]/modules/[moduleId]/content/reorder
          - Content reorder follows same pattern as module reorder
        </keyPoints>
      </doc>
      <doc path="docs/epics-course-modules.md" section="Story 2.4">
        <relevance>Original story specification and detailed acceptance criteria</relevance>
        <keyPoints>
          - Expandable module card shows content items
          - Content items show title, type icon, publish status
          - Drag-and-drop reordering within module
          - "Add Content" button within module context
        </keyPoints>
      </doc>
    </docs>

    <code>
      <file path="prisma/schema.prisma">
        <relevance>Database schema for CourseContent and Module models</relevance>
        <keyElements>
          <element type="model" name="CourseContent">
            - id, title, type (ContentType enum), content, fileUrl, thumbnailUrl
            - orderIndex: Int (for ordering within module)
            - isPublished: Boolean
            - moduleId: String? (foreign key to Module)
            - courseId: String (foreign key to Course)
          </element>
          <element type="enum" name="ContentType">
            - TEXT, VIDEO, DOCUMENT, LINK, SCORM, YOUTUBE
          </element>
          <element type="model" name="Module">
            - id, title, description, orderIndex, isPublished
            - courseId: String
            - content: CourseContent[] (relation)
          </element>
        </keyElements>
      </file>

      <file path="src/app/instructor/courses/[id]/content/page.tsx">
        <relevance>Existing content management page with drag-and-drop implementation</relevance>
        <keyElements>
          <element type="component" name="CourseContentPage">
            - Uses @dnd-kit for drag-and-drop reordering
            - DndContext, SortableContext, useSortable patterns
            - SortableItem component with drag handles (GripVertical)
            - Content type icons mapping (getContentIcon, getContentIconColor)
            - Content CRUD operations (create, edit, delete, togglePublished)
            - File upload handling with S3/R2
            - Form state management for content creation/editing
          </element>
          <element type="interface" name="CourseContent">
            - id, title, type, content, fileUrl, thumbnailUrl
            - orderIndex, isPublished, createdAt
          </element>
          <element type="pattern" name="drag-and-drop">
            - sensors: PointerSensor, KeyboardSensor
            - onDragEnd handler using arrayMove
            - Save order button when hasOrderChanged is true
            - Optimistic UI updates
          </element>
        </keyElements>
      </file>

      <file path="src/app/api/instructor/courses/[id]/content/route.ts">
        <relevance>Existing content API endpoints for GET and POST</relevance>
        <keyElements>
          <element type="endpoint" method="GET">
            - Fetches all content for a course ordered by orderIndex
            - Returns array of CourseContent objects
          </element>
          <element type="endpoint" method="POST">
            - Creates new content with auto-incremented orderIndex
            - Accepts: title, type, content, fileUrl, thumbnailUrl, isPublished
            - Currently creates content at course level (needs moduleId support)
          </element>
        </keyElements>
      </file>

      <file path="src/app/api/instructor/courses/[id]/content/[contentId]/route.ts">
        <relevance>Existing content API endpoints for individual content operations</relevance>
        <keyElements>
          <element type="endpoint" method="GET">
            - Fetches single content item by ID
          </element>
          <element type="endpoint" method="PUT">
            - Updates content item fields
            - Supports partial updates
          </element>
          <element type="endpoint" method="DELETE">
            - Soft deletes content using softDelete utility
          </element>
        </keyElements>
      </file>

      <file path="src/lib/validations/module.ts">
        <relevance>Existing validation schemas for module operations</relevance>
        <keyElements>
          <element type="schema" name="createModuleSchema">
            - Uses Zod for validation
            - title: string (1-200 chars)
            - description: optional string (max 2000 chars)
            - requiresPrevious: boolean (default true)
          </element>
          <element type="schema" name="updateModuleSchema">
            - All fields optional for partial updates
            - Includes isPublished and orderIndex
          </element>
        </keyElements>
      </file>
    </code>

    <dependencies>
      <dependency name="@dnd-kit/core" version="^6.3.1">
        <usage>DndContext, closestCenter, sensors (PointerSensor, KeyboardSensor), DragEndEvent</usage>
        <purpose>Core drag-and-drop functionality for content reordering</purpose>
      </dependency>
      <dependency name="@dnd-kit/sortable" version="^10.0.0">
        <usage>arrayMove, SortableContext, useSortable, verticalListSortingStrategy</usage>
        <purpose>Sortable list implementation for vertical content reordering</purpose>
      </dependency>
      <dependency name="@dnd-kit/utilities" version="^3.2.2">
        <usage>CSS.Transform for drag styling</usage>
        <purpose>Utility functions for drag transforms</purpose>
      </dependency>
      <dependency name="lucide-react" version="^0.514.0">
        <usage>Icons - FileText, Video, File, Link, BookOpen, GripVertical, Eye, EyeOff, Edit3, Trash2, Plus</usage>
        <purpose>UI icons for content types and actions</purpose>
      </dependency>
      <dependency name="next" version="15.3.3">
        <usage>NextRequest, NextResponse, routing, API routes</usage>
        <purpose>Next.js framework for app and API routes</purpose>
      </dependency>
      <dependency name="@prisma/client" version="^6.9.0">
        <usage>Database queries for CourseContent and Module models</usage>
        <purpose>Database ORM for content and module operations</purpose>
      </dependency>
      <dependency name="zod" version="^4.1.13">
        <usage>Schema validation for API inputs</usage>
        <purpose>Runtime validation and type safety</purpose>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="data-integrity">
      <description>Content items must belong to a module within the same course</description>
      <enforcement>Database foreign key constraints ensure moduleId references valid Module</enforcement>
    </constraint>

    <constraint type="backward-compatibility">
      <description>Existing content must support both course-level and module-level operations during transition</description>
      <enforcement>CourseContent.moduleId is nullable; content can exist without moduleId temporarily</enforcement>
    </constraint>

    <constraint type="ui-consistency">
      <description>Content management within modules should match existing content page patterns</description>
      <enforcement>Reuse existing content icons, drag-and-drop patterns, and form components</enforcement>
    </constraint>

    <constraint type="performance">
      <description>Content list loading should not cause noticeable lag for modules with many items</description>
      <enforcement>Consider lazy loading content on module expand; limit eager loading to essential data</enforcement>
    </constraint>

    <constraint type="authorization">
      <description>Only course instructors can manage module content</description>
      <enforcement>API endpoints must verify session.user.role === 'INSTRUCTOR' and course ownership</enforcement>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="CourseContent">
      <location>src/app/instructor/courses/[id]/content/page.tsx</location>
      <definition>
        {
          id: string
          title: string
          type: 'TEXT' | 'VIDEO' | 'DOCUMENT' | 'LINK' | 'SCORM' | 'YOUTUBE'
          content: string | null
          fileUrl: string | null
          thumbnailUrl: string | null
          orderIndex: number
          isPublished: boolean
          createdAt: string
          moduleId?: string
        }
      </definition>
    </interface>

    <interface name="Module">
      <location>New - to be created</location>
      <definition>
        {
          id: string
          title: string
          description: string | null
          orderIndex: number
          isPublished: boolean
          requiresPrevious: boolean
          courseId: string
          content?: CourseContent[]
          contentCount?: number
          assignmentCount?: number
          discussionCount?: number
        }
      </definition>
    </interface>

    <interface name="ContentTypeIcons">
      <location>Story implementation</location>
      <definition>
        const contentTypeIcons: Record&lt;ContentType, string&gt; = {
          TEXT: 'üìÑ',
          VIDEO: 'üé¨',
          DOCUMENT: 'üìÅ',
          LINK: 'üîó',
          SCORM: 'üì¶',
          YOUTUBE: '‚ñ∂Ô∏è'
        }
      </definition>
    </interface>

    <interface name="ReorderContentRequest">
      <location>New API endpoint</location>
      <definition>
        {
          contentIds: string[]  // Array of content IDs in new order
        }
      </definition>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard>All new components must have unit tests using Jest and React Testing Library</standard>
      <standard>API endpoints must have integration tests verifying authorization, validation, and data mutations</standard>
      <standard>Drag-and-drop functionality should have user interaction tests</standard>
      <standard>Test files should be co-located in __tests__ directories or with .test.tsx suffix</standard>
      <standard>Mock Prisma client for unit tests; use test database for integration tests</standard>
    </standards>

    <locations>
      <location>__tests__/unit/components/modules/ModuleContentList.test.tsx</location>
      <location>__tests__/unit/components/modules/ModuleCard.test.tsx</location>
      <location>__tests__/integration/api/instructor/modules/content-reorder.test.ts</location>
    </locations>

    <ideas>
      <test name="ModuleContentList renders content items with correct icons">
        <scenario>Given a module with mixed content types (TEXT, VIDEO, DOCUMENT)</scenario>
        <assertion>Then each content item displays the correct type icon and title</assertion>
      </test>

      <test name="ModuleContentList shows publish status correctly">
        <scenario>Given content items with varying isPublished states</scenario>
        <assertion>Then published items show green indicator and unpublished show draft badge</assertion>
      </test>

      <test name="Expandable module card toggles content visibility">
        <scenario>When user clicks expand toggle on collapsed module</scenario>
        <assertion>Then content list becomes visible with animation</assertion>
        <assertion>And clicking again collapses the content list</assertion>
      </test>

      <test name="Content reordering updates orderIndex via API">
        <scenario>Given a module with 3 content items in order [A, B, C]</scenario>
        <scenario>When user drags item C to first position</scenario>
        <assertion>Then API receives PUT request with contentIds: [C, A, B]</assertion>
        <assertion>And content list re-renders in new order</assertion>
      </test>

      <test name="Add Content button opens form with moduleId pre-filled">
        <scenario>When user clicks "Add Content" within an expanded module</scenario>
        <assertion>Then content creation form opens</assertion>
        <assertion>And moduleId field is pre-populated with current module's ID</assertion>
      </test>

      <test name="Content creation form accepts moduleId parameter">
        <scenario>Given content creation form with moduleId=ABC</scenario>
        <scenario>When user submits new content</scenario>
        <assertion>Then POST request includes moduleId: ABC in request body</assertion>
        <assertion>And new content appears in the module's content list</assertion>
      </test>

      <test name="Content reorder endpoint validates instructor ownership">
        <scenario>Given a user who is not the course instructor</scenario>
        <scenario>When attempting to reorder content in a module</scenario>
        <assertion>Then API returns 401 Unauthorized</assertion>
      </test>

      <test name="Content reorder endpoint validates all IDs belong to module">
        <scenario>When submitting contentIds where one ID belongs to different module</scenario>
        <assertion>Then API returns 400 Bad Request with validation error</assertion>
      </test>

      <test name="Content item click navigates to content editor">
        <scenario>When user clicks on a content item in module content list</scenario>
        <assertion>Then navigation occurs to /instructor/courses/[id]/content/[contentId]</assertion>
      </test>

      <test name="Lazy vs eager loading decision for content">
        <scenario>Given a module with 50+ content items</scenario>
        <assertion>Then content loads on expand (lazy) OR with module list (eager) based on implementation decision</assertion>
        <assertion>And loading state displays skeleton or spinner during fetch</assertion>
      </test>
    </ideas>
  </tests>
</story-context>
