<?xml version="1.0" encoding="UTF-8"?>
<story-context id="1-4" version="1.0">
  <metadata>
    <epic-id>1</epic-id>
    <story-id>4</story-id>
    <title>Add Module Progress Tracking Model</title>
    <status>ready-for-dev</status>
    <generated-at>2025-11-28</generated-at>
    <story-file>docs/stories/1-4-add-module-progress-tracking-model.md</story-file>
  </metadata>

  <story>
    <as-a>developer</as-a>
    <i-want>create a ModuleProgress model to track student completion</i-want>
    <so-that>we can determine when modules are unlocked</so-that>

    <tasks>
      <task id="1" title="Add ModuleProgress model to Prisma schema">
        <subtask id="1.1">Define ModuleProgress model with all required fields</subtask>
        <subtask id="1.2">Add contentViewed String[] array field to track viewed content IDs</subtask>
        <subtask id="1.3">Add completedAt DateTime? for completion timestamp</subtask>
        <subtask id="1.4">Add createdAt and updatedAt timestamp fields</subtask>
        <subtask id="1.5">Configure relation to Module with onDelete: Cascade</subtask>
        <subtask id="1.6">Configure relation to User with onDelete: Cascade</subtask>
        <subtask id="1.7">Add @@map("module_progress") for table naming</subtask>
      </task>

      <task id="2" title="Add unique constraint">
        <subtask id="2.1">Add @@unique([moduleId, userId]) constraint</subtask>
        <subtask id="2.2">Add @@index([userId]) for user-based queries</subtask>
      </task>

      <task id="3" title="Update related models">
        <subtask id="3.1">Add progress ModuleProgress[] relation array to Module model</subtask>
        <subtask id="3.2">Add moduleProgress ModuleProgress[] relation array to User model</subtask>
      </task>

      <task id="4" title="Generate and run migration">
        <subtask id="4.1">Run npx prisma migrate dev --name add_module_progress</subtask>
        <subtask id="4.2">Verify migration creates correct table structure</subtask>
        <subtask id="4.3">Run npx prisma generate to update Prisma client</subtask>
      </task>
    </tasks>
  </story>

  <acceptance-criteria>
    <criterion id="AC1">ModuleProgress model created with: id, moduleId, userId, completedAt, contentViewed (String array)</criterion>
    <criterion id="AC2">Unique constraint on (moduleId, userId) enforced</criterion>
    <criterion id="AC3">Relations established to Module and User models with cascade deletes</criterion>
    <criterion id="AC4">Prisma migration runs successfully and creates module_progress table</criterion>
  </acceptance-criteria>

  <artifacts>
    <documentation>
      <doc path="docs/architecture-course-modules.md" section="ModuleProgress Model">
        <description>Complete ModuleProgress model specification with all fields and relations</description>
        <key-points>
          <point>Model structure: id, completedAt, contentViewed[], createdAt, updatedAt</point>
          <point>Relations: moduleId -> Module, userId -> User (both with cascade delete)</point>
          <point>Unique constraint prevents duplicate progress records</point>
          <point>Index on userId for efficient user-based queries</point>
          <point>Table mapping: @@map("module_progress")</point>
        </key-points>
      </doc>

      <doc path="docs/architecture-course-modules.md" section="ADR-002">
        <description>Progress formula decision (50% content + 50% assignments)</description>
        <key-points>
          <point>contentViewed tracks array of content IDs student has viewed</point>
          <point>Progress calculation uses contentViewed.length / totalContent for 50%</point>
          <point>completedAt is nullable - only set when module reaches 100%</point>
        </key-points>
      </doc>

      <doc path="docs/PRD-course-modules.md" section="FR019, FR020">
        <description>Functional requirements for module completion tracking</description>
        <key-points>
          <point>FR019: Module completion tracked (all content viewed, all assignments submitted)</point>
          <point>FR020: Students can see progress through each module</point>
        </key-points>
      </doc>
    </documentation>

    <code>
      <file path="prisma/schema.prisma">
        <description>Current Prisma schema with User model</description>
        <relevant-sections>
          <section name="User model" lines="11-40">
            <note>Need to add moduleProgress ModuleProgress[] relation</note>
            <note>User model already has id field for ModuleProgress.userId relation</note>
          </section>
          <section name="Module model" lines="N/A">
            <note>Module model will be created in Story 1.1 (prerequisite)</note>
            <note>Must add progress ModuleProgress[] relation to Module after creation</note>
          </section>
        </relevant-sections>
      </file>
    </code>

    <dependencies>
      <dependency type="tool" name="Prisma" version="^6.9.0">
        <description>Database ORM and migration tool</description>
        <usage>Schema definition and migration generation</usage>
      </dependency>

      <dependency type="story" name="1-1-create-module-database-model">
        <description>Module model must exist before ModuleProgress can reference it</description>
        <status>drafted</status>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="database">
      <title>Unique constraint on (moduleId, userId)</title>
      <description>Only one progress record per user per module allowed</description>
      <rationale>Prevents duplicate tracking entries for same user-module combination</rationale>
    </constraint>

    <constraint type="database">
      <title>Cascade delete on both relations</title>
      <description>When Module or User is deleted, associated ModuleProgress records are automatically deleted</description>
      <rationale>Maintains referential integrity and prevents orphaned progress records</rationale>
    </constraint>

    <constraint type="data">
      <title>contentViewed is String array</title>
      <description>Stores list of content IDs the user has viewed</description>
      <rationale>Enables tracking partial progress through module content</rationale>
    </constraint>

    <constraint type="data">
      <title>completedAt is nullable</title>
      <description>Only set when module reaches 100% completion</description>
      <rationale>Distinguishes between in-progress and completed modules</rationale>
    </constraint>
  </constraints>

  <interfaces>
    <interface name="Module relation">
      <description>ModuleProgress belongs to one Module</description>
      <fields>
        <field name="moduleId" type="String" required="true">Foreign key to modules table</field>
        <field name="module" type="Module" relation="true">Module relation (onDelete: Cascade)</field>
      </fields>
    </interface>

    <interface name="User relation">
      <description>ModuleProgress belongs to one User</description>
      <fields>
        <field name="userId" type="String" required="true">Foreign key to users table</field>
        <field name="user" type="User" relation="true">User relation (onDelete: Cascade)</field>
      </fields>
    </interface>

    <interface name="ModuleProgress fields">
      <description>Core tracking fields for module progress</description>
      <fields>
        <field name="id" type="String" required="true">Primary key (cuid)</field>
        <field name="completedAt" type="DateTime?" required="false">Completion timestamp (nullable)</field>
        <field name="contentViewed" type="String[]" required="true">Array of viewed content IDs</field>
        <field name="createdAt" type="DateTime" required="true">Record creation timestamp</field>
        <field name="updatedAt" type="DateTime" required="true">Record update timestamp</field>
      </fields>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <approach>E2E testing with Playwright</approach>
      <framework>Playwright (v1.57.0)</framework>
      <location>__tests__/e2e/</location>
      <commands>
        <command name="test:e2e">Run all E2E tests</command>
        <command name="test:e2e:ui">Run tests with Playwright UI</command>
        <command name="test:e2e:debug">Run tests in debug mode</command>
      </commands>
    </standards>

    <test-locations>
      <directory>__tests__/e2e/</directory>
      <pattern>*.spec.ts</pattern>
      <note>No unit tests directory exists yet - E2E tests are primary testing approach</note>
    </test-locations>

    <test-ideas>
      <idea priority="high">Migration verification: Verify module_progress table created with correct schema</idea>
      <idea priority="high">Unique constraint: Attempt to create duplicate progress records and verify error</idea>
      <idea priority="high">Cascade delete on Module: Delete a module and verify progress records deleted</idea>
      <idea priority="high">Cascade delete on User: Delete a user and verify progress records deleted</idea>
      <idea priority="medium">Data types: Verify contentViewed accepts array of strings</idea>
      <idea priority="medium">Nullable completedAt: Create progress record without completedAt, then update it</idea>
      <idea priority="medium">Timestamps: Verify createdAt and updatedAt auto-populate correctly</idea>
      <idea priority="low">Index verification: Query by userId and verify performance (manual testing)</idea>
    </test-ideas>
  </tests>

  <implementation-notes>
    <note category="order">
      <title>Story can be worked in parallel with Story 1.3</title>
      <description>Data migration story (1.3) and ModuleProgress model creation (1.4) are independent and can run concurrently</description>
    </note>

    <note category="architecture">
      <title>Progress calculation context</title>
      <description>The progress formula per ADR-002: 50% from content viewing (contentViewed.length / totalContent) + 50% from assignment submission (from Submission table, not stored in ModuleProgress)</description>
    </note>

    <note category="future">
      <title>contentViewed usage</title>
      <description>The contentViewed array is updated by the content completion API which will be implemented in Epic 3</description>
    </note>

    <note category="data">
      <title>No existing progress data</title>
      <description>ModuleProgress table starts empty. Progress tracking begins after module feature launches</description>
    </note>

    <note category="schema">
      <title>Table naming convention</title>
      <description>Use @@map("module_progress") to follow PostgreSQL snake_case naming convention used throughout schema</description>
    </note>
  </implementation-notes>

  <references>
    <reference type="architecture">
      <source>docs/architecture-course-modules.md#ModuleProgress-Model</source>
      <description>Complete model specification with field definitions and relations</description>
    </reference>

    <reference type="architecture">
      <source>docs/architecture-course-modules.md#ADR-002</source>
      <description>Progress formula decision (50/50 split between content and assignments)</description>
    </reference>

    <reference type="prd">
      <source>docs/PRD-course-modules.md#Functional-Requirements</source>
      <description>FR019 and FR020 define progress tracking requirements</description>
    </reference>

    <reference type="epic">
      <source>docs/epics-course-modules.md#Story-1.4</source>
      <description>Original story specification in epic breakdown</description>
    </reference>

    <reference type="story">
      <source>docs/stories/1-3-create-data-migration-script.md</source>
      <description>Related story - confirms Module model exists and no existing progress data</description>
    </reference>
  </references>
</story-context>
